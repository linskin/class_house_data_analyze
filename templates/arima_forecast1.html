<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>ARIMA 预测</title>
    <!-- 引入 ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <!-- 引入 JQuery  -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Font Awesome 用于图标 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            position: relative; /* 用于定位回首页按钮 */
        }

        h1 {
            color: #333;
            font-weight: 600;
            margin-bottom: 20px;
        }

        #chart {
            width: 80%;
            height: 60%;
            margin-bottom: 20px;
        }

        .button-container {
            display: flex;
            gap: 10px;
        }

        .export-btn, .home-btn {
            background-color: #007BFF;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            align-items: center;
        }

        .export-btn i, .home-btn i {
            margin-right: 8px;
        }

        .export-btn:hover {
            background-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
        }

        /* 回首页按钮定位和样式 */
        .home-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #28a745; /* 使用不同颜色 */
        }

        .home-btn:hover {
            background-color: #218838;
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
        }
    </style>
</head>
<body>
<!-- 图表容器 -->
<div id="chart"></div>

<!-- 导出按钮 -->
<div class="button-container">
    <button class="export-btn" onclick="exportChart()">
        <i class="fas fa-download"></i>导出图表
    </button>
</div>

<!-- 回首页按钮 -->
<button class="home-btn" onclick="goHome()">
    <i class="fas fa-home"></i>回首页
</button>

<h2>Email Verification</h2>

<!-- 发送验证码表单 -->
<form id="send-code-form">
    <label for="email">Email:</label>
    <input id="email" name="email" required type="email">
    <button type="submit">Send Verification Code</button>
    <p id="send-code-message"></p>
</form>

<hr>

<!-- 验证验证码表单 -->
<form id="verify-code-form">
    <label for="code">Verification Code:</label>
    <input id="code" name="code" required type="text">
    <button type="submit">Verify Code</button>
    <p id="verify-code-message"></p>
</form>

<script>
    // 发送验证码 AJAX 请求
    $('#send-code-form').on('submit', function (e) {
        e.preventDefault();
        var email = $('#email').val();

        $.ajax({
            url: "{% url 'send_verification_email' %}",
            method: "POST",
            data: {
                email: email,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function (response) {
                $('#send-code-message').text(response.message);
            },
            error: function (response) {
                $('#send-code-message').text(response.responseJSON.error);
            }
        });
    });

    // 验证验证码 AJAX 请求
    $('#verify-code-form').on('submit', function (e) {
        e.preventDefault();
        var email = $('#email').val();
        var code = $('#code').val();

        $.ajax({
            url: "{% url 'verify_code' %}",
            method: "POST",
            data: {
                email: email,
                code: code,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function (response) {
                $('#verify-code-message').text(response.message);
            },
            error: function (response) {
                $('#verify-code-message').text(response.responseJSON.error);
            }
        });
    });
    // 验证验证码 AJAX 请求
    $('#verify-code-form').on('submit', function (e) {
        e.preventDefault();
        var email = $('#email').val();
        var code = $('#code').val();

        $.ajax({
            url: "{% url 'verify_code' %}",
            method: "POST",
            data: {
                email: email,
                code: code,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function (response) {
                $('#verify-code-message').text(response.message);

                // 验证成功后将图表导出为 PNG 并发送到邮箱
                var chartImage = chart.getDataURL({
                    type: 'png',
                    pixelRatio: 2,
                    backgroundColor: '#fff'
                });

                $.ajax({
                    url: "{% url 'send_chart_email' %}",
                    method: "POST",
                    data: {
                        email: email,
                        chart_image: chartImage,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function (response) {
                        alert('图表已发送至邮箱');
                    },
                    error: function (response) {
                        alert('发送图表时出错');
                    }
                });
            },
            error: function (response) {
                $('#verify-code-message').text(response.responseJSON.error);
            }
        });
    });


    // 从 Django 后端获取数据
    var dates = {
    {
        dates | safe
    }
    }

    var actual_values = {
    {
        actual_values | safe
    }
    }

    var fitted_values = {
    {
        fitted_values | safe
    }
    }

    var forecast_dates = {
    {
        forecast_dates | safe
    }
    }

    var forecast_values = {
    {
        forecast_values | safe
    }
    }


    // 合并所有日期用于 x 轴
    var all_dates = dates.concat(forecast_dates);

    // 初始化 ECharts
    var chart = echarts.init(document.getElementById('chart'));

    // 配置 ECharts 图表
    var option = {
        title: {
            text: 'ARIMA模型拟合及预测结果',
            left: 'center',
            subtext: '数据来源：中国房价数据',
        },
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data: ['实际值', '拟合值', '预测值'],
            top: '10%'
        },
        xAxis: {
            type: 'category',
            data: all_dates
        },
        yAxis: {
            type: 'value',
            name: '平均房屋单价'
        },
        series: [
            {
                name: '实际值',
                type: 'line',
                data: actual_values
            },
            {
                name: '拟合值',
                type: 'line',
                data: fitted_values
            },
            {
                name: '预测值',
                type: 'line',
                data: new Array(dates.length).fill(null).concat(forecast_values),
                lineStyle: {
                    type: 'dashed'
                }
            }
        ]
    };

    // 绘制图表
    chart.setOption(option);

    // 导出图表功能
    function exportChart() {
        var link = document.createElement('a');
        link.href = chart.getDataURL({
            type: 'png',  // 可选类型: 'png', 'jpeg'
            pixelRatio: 2,  // 增加分辨率
            backgroundColor: '#fff'
        });
        link.download = 'arima_forecast_chart.png';
        link.click();
    }

    // 回首页功能
    function goHome() {
        window.location.href = '/';  // 假设首页路径为 '/'
    }
</script>
</body>
</html>
